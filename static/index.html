<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EquipGPT . Electrical PDF extractor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      /* Light theme palette */
      --bg-main: #f7f7f8;
      --bg-chat: #ffffff;
      --bg-message-user: #e8f5f0;
      --bg-message-assistant: #f3f4f6;
      --bg-message-assistant-alt: #eef0f5;
      --border-subtle: #e0e0ea;
      --accent: #10a37f;
      --accent-soft: rgba(16, 163, 127, 0.06);
      --accent-soft-2: rgba(16, 163, 127, 0.22);
      --accent-border: rgba(16, 163, 127, 0.6);
      --text-main: #202123;
      --text-muted: #6b7280;
      --sidebar-bg: #ffffff;
      --sidebar-border: #e5e7eb;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.12);
      --radius-lg: 10px;
      --radius-md: 6px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #ffffff 0, #f7f7f8 55%);
    }

    body {
      display: flex;
    }

    .app {
      display: flex;
      height: 100vh;
      width: 100%;
      overflow: hidden;
    }

    /* Main chat area */

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #ffffff 0, #f7f7f8 55%);
    }

    .chat-header {
      height: 56px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--text-muted);
      position: relative;
      background: radial-gradient(circle at top, rgba(255,255,255,0.9), transparent 55%);
    }

    .chat-header-title {
      font-size: 13px;
      color: var(--text-main);
      font-weight: 500;
    }

    .chat-header-pill {
      position: absolute;
      right: 18px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-border);
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 10px rgba(16, 163, 127, 0.15);
    }

    .chat-header-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(16, 163, 127, 0.65);
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
      scroll-behavior: smooth;
      background: radial-gradient(circle at top, rgba(255,255,255,0.8), transparent 55%);
      border-radius: var(--radius-lg);
    }

    .chat-inner {
      max-width: 820px;
      margin: 0 auto;
      padding: 0 16px 90px;
    }

    .message {
      display: flex;
      gap: 12px;
      padding: 18px 18px;
      font-size: 14px;
      line-height: 1.5;
      border-radius: var(--radius-lg);
    }

    .message.user {
      background: var(--bg-message-user);
      border-top: 1px solid var(--border-subtle);
      border-bottom: 1px solid var(--border-subtle);
    }

    .message.assistant {
      background: var(--bg-message-assistant);
      border-top: 1px solid var(--border-subtle);
      border-bottom: 1px solid var(--border-subtle);
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 15px;
    }

    .avatar.user {
      background: #10a37f;
      color: #ffffff;
      font-weight: 600;
    }

    .avatar.assistant {
      background: #202123;
      color: #ffffff;
      font-weight: 600;
    }

    .message-content {
      flex: 1;
      color: var(--text-main);
      white-space: pre-wrap;
    }

    .message-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .message-content a {
      color: var(--accent);
      text-decoration: none;
    }

    .message-content a:hover {
      text-decoration: underline;
    }

    .message-highlight {
      margin-top: 8px;
      padding: 10px 11px;
      border-radius: 8px;
      border: 1px solid var(--accent-soft-2);
      background: radial-gradient(circle at top left, rgba(16,163,127,0.12), rgba(16,163,127,0.02));
      font-size: 13px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    .message-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .message-tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .counts-row {
      margin-top: 6px;
      font-size: 13px;
      color: #111827;
    }

    .counts-row span.label {
      color: var(--text-muted);
    }

    .download-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--accent-border);
      background: #ffffff;
      font-size: 13px;
      color: var(--accent);
      text-decoration: none;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(16, 163, 127, 0.1);
    }

    .download-btn:hover {
      background: var(--accent-soft);
      box-shadow: 0 4px 8px rgba(16, 163, 127, 0.15);
    }

    /* Input area */

    .chat-input-wrapper {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 16px 16px;
      background: linear-gradient(to top, rgba(247, 247, 248, 1), rgba(247, 247, 248, 0.96), transparent);
      border-top: 1px solid #e5e7eb;
    }

    .chat-input-inner {
      max-width: 820px;
      margin: 0 auto;
    }

    .chat-input-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid #d4d4dd;
      box-shadow: var(--shadow-soft);
    }

    .chat-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
    }

    .chat-input::placeholder {
      color: var(--text-muted);
    }

    .attach-btn {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .attach-btn:hover {
      background: var(--accent-soft-2);
      color: var(--accent);
      box-shadow: 0 2px 4px rgba(16, 163, 127, 0.2);
    }

    .send-btn {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--accent);
      color: #ffffff;
      font-size: 18px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(16, 163, 127, 0.3);
    }

    .send-btn:hover {
      background: #0d8c6e;
      box-shadow: 0 4px 8px rgba(16, 163, 127, 0.4);
    }

    .send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .hint-row {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .hint-row span.file {
      color: #374151;
    }

    .hint-row span.error {
      color: #dc2626;
    }

    .hidden-input {
      display: none;
    }

    .equipment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .equipment-table th, .equipment-table td {
      border: 1px solid var(--border-subtle);
      padding: 8px;
      text-align: left;
    }

    .equipment-table th {
      background: var(--bg-message-assistant-alt);
      font-weight: bold;
    }

    .equipment-table td[contenteditable="true"] {
      background: #fff;
      cursor: text;
    }

    .equipment-table td[contenteditable="true"]:focus {
      outline: 1px solid var(--accent);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .pagination button {
      padding: 8px 14px;
      border: 1px solid var(--accent-border);
      background: #ffffff;
      color: var(--accent);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(16, 163, 127, 0.1);
    }

    .pagination button:hover {
      background: var(--accent-soft);
      box-shadow: 0 4px 8px rgba(16, 163, 127, 0.15);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination span {
      font-size: 13px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Main chat column -->
    <main class="chat">
      <div class="chat-header">
        <div class="chat-header-title">EquipGPT . Electrical PDF extractor</div>
        <div class="chat-header-pill">
          <span class="chat-header-pill-dot"></span>
          <span id="statusLabel">Ready</span>
        </div>
      </div>

      <div class="chat-window">
        <div class="chat-inner" id="chatWindow">
          <!-- Initial assistant message -->
          <div class="message assistant">
            <div class="avatar assistant">E</div>
            <div class="message-content">
              <div class="message-meta">EquipGPT</div>
              Drop in a medium voltage PDF using the paperclip icon, then hit send and I will extract MVS and DSG equipment, map Primary and Alternate feeds, and give you an Excel download link.
            </div>
          </div>
        </div>
      </div>

      <!-- Input area -->
      <div class="chat-input-wrapper">
        <div class="chat-input-inner">
          <form id="chatForm">
            <div class="chat-input-bar">
              <button type="button" class="attach-btn" id="attachBtn" title="Attach PDF">
                ðŸ“Ž
              </button>
              <input
                id="promptInput"
                class="chat-input"
                placeholder="Upload a PDF and click send to extract equipment data"
                autocomplete="off"
              />
              <button type="submit" id="sendBtn" class="send-btn" title="Send">
                âž¤
              </button>
              <input
                type="file"
                id="pdfInput"
                class="hidden-input"
                accept="application/pdf"
              />
            </div>
          </form>
          <div class="hint-row">
            <span id="fileHint" class="file">No file selected</span>
            <span id="errorHint" class="error"></span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script>
    const endpointUrl = "/extract";

    const chatWindow = document.getElementById("chatWindow");
    const chatForm = document.getElementById("chatForm");
    const promptInput = document.getElementById("promptInput");
    const pdfInput = document.getElementById("pdfInput");
    const sendBtn = document.getElementById("sendBtn");
    const fileHint = document.getElementById("fileHint");
    const errorHint = document.getElementById("errorHint");
    const statusLabel = document.getElementById("statusLabel");
    const attachBtn = document.getElementById("attachBtn");

    let selectedFile = null;

    function scrollToBottom() {
      const container = document.querySelector(".chat-window");
      container.scrollTop = container.scrollHeight;
    }

    function addMessage(role, text, metaText = "", highlight = null) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${role}`;

      const avatar = document.createElement("div");
      avatar.className = `avatar ${role}`;
      avatar.textContent = role === "user" ? "U" : "E";

      const content = document.createElement("div");
      content.className = "message-content";

      if (metaText) {
        const meta = document.createElement("div");
        meta.className = "message-meta";
        meta.textContent = metaText;
        content.appendChild(meta);
      }

      const main = document.createElement("div");
      main.textContent = text;
      content.appendChild(main);

      if (highlight) {
        const highlightBox = document.createElement("div");
        highlightBox.className = "message-highlight";

        if (highlight.tag) {
          const tag = document.createElement("div");
          tag.className = "message-tag";
          const dot = document.createElement("span");
          dot.className = "message-tag-dot";
          const label = document.createElement("span");
          label.textContent = highlight.tag;
          tag.appendChild(dot);
          tag.appendChild(label);
          highlightBox.appendChild(tag);
        }

        if (highlight.html) {
          const holder = document.createElement("div");
          holder.innerHTML = highlight.html;
          highlightBox.appendChild(holder);
        }

        content.appendChild(highlightBox);
      }

      wrapper.appendChild(avatar);
      wrapper.appendChild(content);
      chatWindow.appendChild(wrapper);
      scrollToBottom();
      return wrapper;
    }

    function updateAssistantMessage(wrapper, newText, highlight = null) {
      if (!wrapper) return;
      const content = wrapper.querySelector(".message-content");
      if (!content) return;

      content.innerHTML = "";

      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = "EquipGPT";
      content.appendChild(meta);

      const main = document.createElement("div");
      main.textContent = newText;
      content.appendChild(main);

      if (highlight) {
        const highlightBox = document.createElement("div");
        highlightBox.className = "message-highlight";

        if (highlight.tag) {
          const tag = document.createElement("div");
          tag.className = "message-tag";
          const dot = document.createElement("span");
          dot.className = "message-tag-dot";
          const label = document.createElement("span");
          label.textContent = highlight.tag;
          tag.appendChild(dot);
          tag.appendChild(label);
          highlightBox.appendChild(tag);
        }

        if (highlight.html) {
          const holder = document.createElement("div");
          holder.innerHTML = highlight.html;
          highlightBox.appendChild(holder);
        }

        content.appendChild(highlightBox);
      }
      scrollToBottom();
    }

    attachBtn.addEventListener("click", () => {
      pdfInput.click();
    });

    pdfInput.addEventListener("change", () => {
      const file = pdfInput.files[0];
      if (!file) {
        selectedFile = null;
        fileHint.textContent = "No file selected";
        return;
      }
      selectedFile = file;
      fileHint.textContent = `Selected. ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
      errorHint.textContent = "";
    });

    function setLoading(isLoading) {
      sendBtn.disabled = isLoading;
      statusLabel.textContent = isLoading ? "Processing PDF" : "Ready";
    }

    chatForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      errorHint.textContent = "";

      if (!selectedFile) {
        errorHint.textContent = "Please attach a PDF first";
        addMessage(
          "assistant",
          "I need a PDF to work with, please attach a file using the paperclip icon first.",
          "EquipGPT"
        );
        return;
      }

      if (selectedFile.type !== "application/pdf") {
        errorHint.textContent = "Invalid file type, only PDF is allowed";
        addMessage(
          "assistant",
          "That file is not a PDF, please select a .pdf file.",
          "EquipGPT"
        );
        return;
      }

      const userText = promptInput.value.trim();
      const summary = userText
        ? `Run extraction on ${selectedFile.name}. ${userText}`
        : `Run extraction on ${selectedFile.name}.`;

      addMessage("user", summary, "You");

      const placeholder = addMessage(
        "assistant",
        "Processing your PDF in the backend, this may take a moment.",
        "EquipGPT"
      );

      setLoading(true);

      try {
        const formData = new FormData();
        formData.append("file", selectedFile);

        const response = await fetch(endpointUrl, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const text = await response.text();
          errorHint.textContent = `Backend error. ${response.status}`;
          updateAssistantMessage(
            placeholder,
            "The backend returned an error while processing your PDF.",
            {
              tag: "Error",
              html: `<div>${response.status} ${response.statusText}</div><div style="margin-top:4px; font-size:12px; color:#b91c1c;">${text || "No error body returned"}</div>`,
            }
          );
          return;
        }

        const data = await response.json();

        const mvsCount = data.mvs_count ?? data.mvs ?? 0;
        const dsgCount = data.dsg_count ?? data.dsg ?? 0;
        const excelUrlRaw = data.excel_url || data.excelUrl || data.output_url;
        const excelUrl = excelUrlRaw
          ? (excelUrlRaw.startsWith("http")
              ? excelUrlRaw
              : new URL(excelUrlRaw, window.location.origin).toString())
          : null;

        const baseText = "Extraction finished successfully, I parsed your PDF and created an Excel file with the equipment list and connection mapping.";

        let html = `<div class="counts-row"><span class="label">MVS count.</span> ${mvsCount}, <span class="label">DSG count.</span> ${dsgCount}</div>`;

        if (excelUrl) {
          const name = data.output_name || "Download equipment_data.xlsx";
          html += `<a class="download-btn" href="${excelUrl}" target="_blank" rel="noopener noreferrer">â¬‡ Excel file. ${name}</a>`;
        } else {
          html += `<div class="counts-row" style="margin-top:4px; color:#ca8a04;">Backend did not return a download URL, adjust the FastAPI response if you want a direct link here.</div>`;
        }

        updateAssistantMessage(placeholder, baseText, {
          tag: "Result",
          html,
        });

        // Add paginated table
        const equipmentList = data.equipment_list;
        if (equipmentList && equipmentList.length > 0) {
          const highlightBox = chatWindow.querySelector('.message:last-child .message-highlight');
          if (highlightBox) {
            const tableDiv = document.createElement('div');
            tableDiv.className = 'equipment-table-container';

            const table = document.createElement('table');
            table.className = 'equipment-table';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Equipment', 'Type', 'Properties', 'Alternate From', 'Primary From'].forEach(col => {
              const th = document.createElement('th');
              th.textContent = col;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            table.appendChild(tbody);

            const pageSize = 50;
            const totalPages = Math.ceil(equipmentList.length / pageSize);
            let currentPage = 1;

            function renderPage(page) {
              tbody.innerHTML = '';
              const start = (page - 1) * pageSize;
              const end = Math.min(start + pageSize, equipmentList.length);
              for (let i = start; i < end; i++) {
                const item = equipmentList[i];
                const tr = document.createElement('tr');
                ['Equipment', 'Type', 'Properties', 'Alternate From', 'Primary From'].forEach(key => {
                  const td = document.createElement('td');
                  td.textContent = item[key] || '';
                  td.contentEditable = true;
                  td.addEventListener('input', () => {
                    item[key] = td.textContent.trim();
                  });
                  tr.appendChild(td);
                });
                tbody.appendChild(tr);
              }
            }

            renderPage(1);

            const pagination = document.createElement('div');
            pagination.className = 'pagination';

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = true;
            prevBtn.addEventListener('click', () => {
              if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
              }
            });

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = totalPages <= 1;
            nextBtn.addEventListener('click', () => {
              if (currentPage < totalPages) {
                currentPage++;
                renderPage(currentPage);
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
              }
            });

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'Download Updated XLSX';
            downloadBtn.addEventListener('click', () => {
              const wsData = [
                ['Equipment', 'Type', 'Properties', 'Alternate From', 'Primary From'],
                ...equipmentList.map(item => [
                  item.Equipment || '',
                  item.Type || '',
                  item.Properties || '',
                  item['Alternate From'] || '',
                  item['Primary From'] || ''
                ])
              ];
              const ws = XLSX.utils.aoa_to_sheet(wsData);
              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, 'Equipment Data');
              XLSX.writeFile(wb, 'updated_equipment_data.xlsx');
            });

            pagination.appendChild(prevBtn);
            pagination.appendChild(pageInfo);
            pagination.appendChild(nextBtn);
            pagination.appendChild(downloadBtn);

            tableDiv.appendChild(table);
            tableDiv.appendChild(pagination);
            highlightBox.appendChild(tableDiv);
            scrollToBottom();
          }
        }

        statusLabel.textContent = "Ready";
        promptInput.value = "";
      } catch (err) {
        console.error(err);
        errorHint.textContent = "Network or script error, check console";
        updateAssistantMessage(
          placeholder,
          "Something went wrong while talking to the backend.",
          {
            tag: "Error",
            html: `<div style="font-size:12px; color:#b91c1c;">${err.message}</div>`,
          }
        );
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
