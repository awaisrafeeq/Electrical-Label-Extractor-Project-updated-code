<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EquipGPT PDF Table Extractor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background: #f7f7f8; margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; min-height: 100vh; }
    .container { max-width: 820px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12); padding: 32px 24px 32px 24px; }
    .heading { font-size: 1.3rem; color: #10a37f; font-weight: 600; margin-bottom: 8px; }
    .subheading { color: #374151; font-size: 15px; margin-bottom: 18px; }
    label { display: block; margin-bottom: 8px; font-size: 14px; color: #232323; }
    .file-row { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
    .file-label {min-width:90px; font-size:14px; color:#6b7280}
    .file-name { font-size: 15px; color: #374151; }
    .error { color: #dc2626; font-size: 13px; margin-left: 12px; }
    .status { color: #10a37f; font-size: 13px; margin-left: 12px; }
    .input-bar { margin-bottom: 20px; display:flex; gap:10px; align-items:center }
    input[type="file"] { display: none; }
    .btn, button[type="submit"] { background: #10a37f; color: #fff; border: none; border-radius: 6px; padding: 8px 18px; font-size: 14px; cursor: pointer; transition: background 0.15s; }
    .btn[disabled], button[disabled] { opacity: 0.5; cursor: not-allowed; }
    .btn:hover:enabled { background: #14855c; }
    .equipment-table { width: 100%; border-collapse: collapse; margin-top: 18px; }
    .equipment-table th, .equipment-table td { border: 1px solid #e0e0ea; padding: 8px; text-align: left; }
    .equipment-table th { background: #eef0f5; font-weight: bold; }
    .equipment-table td[contenteditable="true"] { background: #fff; cursor: text; }
    .equipment-table td[contenteditable="true"]:focus { outline: 1px solid #10a37f; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 14px; }
    .pagination button { padding: 6px 12px; border-radius: 999px; background: #fff; border: 1px solid #10a37f; color: #10a37f; cursor: pointer; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination span { font-size: 13px; color: #6b7280; }
    .download-btn { display: inline-flex; align-items: center; gap: 7px; margin-top: 14px; padding: 8px 14px; border-radius: 999px; border: 1px solid #10a37f; background: #fff; font-size: 14px; color: #10a37f; text-decoration: none; cursor: pointer; }
    .download-btn:hover { background: rgba(16,163,127,0.06); }
  </style>
</head>
<body>
  <div class="container">
    <div class="heading">EquipGPT PDF Table Extractor</div>
    <div class="subheading">Upload a medium voltage PDF to extract equipment and connection mapping to Excel.</div>
    <form id="uploadForm" style="margin-bottom:24px">
      <div class="input-bar">
        <label class="btn" for="pdfInput">Choose PDF</label>
        <input type="file" id="pdfInput" accept="application/pdf" />
        <span id="fileName" class="file-name">No file selected</span>
        <button type="submit" class="btn" id="sendBtn">Send</button>
      </div>
      <span id="statusMsg" class="status"></span>
      <div id="loader" style="display:none;justify-content:center;align-items:center;margin:16px 0;">
        <svg width="48" height="48" viewBox="0 0 40 40" fill="#10a37f"><circle cx="20" cy="20" r="16" stroke-width="4" stroke="#10a37f" stroke-dasharray="80" stroke-linecap="round" fill="none"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" from="0 20 20" to="360 20 20"/></circle></svg>
      </div>
      <span id="errorMsg" class="error"></span>
          </form>
    <div id="resultArea"></div>
  </div>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script>
    const endpointUrl = "https://electrical-label-extractor-project-mcj3.onrender.com/extract";
    const pdfInput = document.getElementById("pdfInput");
    const fileName = document.getElementById("fileName");
    const statusMsg = document.getElementById("statusMsg");
    const errorMsg = document.getElementById("errorMsg");
    const form = document.getElementById("uploadForm");
    const sendBtn = document.getElementById("sendBtn");
    const resultArea = document.getElementById("resultArea");
    let selectedFile = null;
    pdfInput.addEventListener("change", () => {
      const file = pdfInput.files[0];
      if (!file) {
        selectedFile = null;
        fileName.textContent = "No file selected";
        return;
      }
      selectedFile = file;
      fileName.textContent = `${file.name} (${(file.size/(1024*1024)).toFixed(2)} MB)`;
      errorMsg.textContent = "";
    });
    function setLoading(isLoading) {
      sendBtn.disabled = isLoading;
      statusMsg.textContent = "";
      document.getElementById("loader").style.display = isLoading ? "flex" : "none";
    }
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMsg.textContent = statusMsg.textContent = resultArea.textContent = "";
      if (!selectedFile) {
        errorMsg.textContent = "Please select a PDF first.";
        return;
      }
      if (selectedFile.type !== "application/pdf") {
        errorMsg.textContent = "Invalid file type, only PDF allowed.";
        return;
      }
      setLoading(true);
      try {
        const formData = new FormData();
        formData.append("file", selectedFile);
        const response = await fetch(endpointUrl, {
          method: "POST",
          body: formData,
        });
        if (!response.ok) {
          const text = await response.text();
          errorMsg.textContent = `Backend error: ${response.status} ${response.statusText}\n${text || ""}`;
          setLoading(false);
          return;
        }
        const data = await response.json();
        showResultTable(data);
      } catch (err) {
        errorMsg.textContent = "Network or script error: " + err.message;
      } finally {
        setLoading(false);
      }
    });
    function showResultTable(data) {
      resultArea.innerHTML = '';
      const mvsCount = data.mvs_count || data.mvs || 0;
      const dsgCount = data.dsg_count || data.dsg || 0;
      let html = `<div style="margin-bottom:7px;font-size:15px;color:#374151;">MVS: <b>${mvsCount}</b> | DSG: <b>${dsgCount}</b></div>`;
        const excelUrlRaw = data.excel_url || data.excelUrl || data.output_url;
      let excelUrl = excelUrlRaw ? (excelUrlRaw.startsWith("http") ? excelUrlRaw : new URL(excelUrlRaw, window.location.origin).toString()) : null;        if (excelUrl) {
          const name = data.output_name || "Download equipment_data.xlsx";
        html += `<a class="download-btn" href="${excelUrl}" target="_blank" rel="noopener noreferrer">⬇ Original Excel file (${name})</a>`;
      }
      resultArea.innerHTML = html;
      // Equipment table
      const equipmentList = data.equipment_list || [];
      if (!equipmentList.length) return;
            const table = document.createElement('table');
            table.className = 'equipment-table';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Equipment', 'Type', 'Properties', 'Alternate From', 'Primary From'].forEach(col => {
              const th = document.createElement('th');
              th.textContent = col;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);
      // Pagination
            const pageSize = 50;
            const totalPages = Math.ceil(equipmentList.length / pageSize);
            let currentPage = 1;
            function renderPage(page) {
              tbody.innerHTML = '';
              const start = (page - 1) * pageSize;
              const end = Math.min(start + pageSize, equipmentList.length);
              for (let i = start; i < end; i++) {
                const item = equipmentList[i];
                const tr = document.createElement('tr');
                ['Equipment', 'Type', 'Properties', 'Alternate From', 'Primary From'].forEach(key => {
                  const td = document.createElement('td');
                  td.textContent = item[key] || '';
                  td.contentEditable = true;
            td.addEventListener('input', () => { item[key] = td.textContent.trim(); });
                  tr.appendChild(td);
                });
                tbody.appendChild(tr);
              }
            }
            renderPage(1);
      // Pagination controls
            const pagination = document.createElement('div');
            pagination.className = 'pagination';
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = true;
            prevBtn.addEventListener('click', () => {
        if (currentPage > 1) { currentPage--; renderPage(currentPage); updatePagi(); }
      });
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = totalPages <= 1;
            nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) { currentPage++; renderPage(currentPage); updatePagi(); }
      });
      const pageInfo = document.createElement('span');
      function updatePagi() {
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
              }
      updatePagi();
            const downloadBtn = document.createElement('button');
      downloadBtn.textContent = '⬇ Download Updated XLSX';
      downloadBtn.className = 'download-btn';
            downloadBtn.addEventListener('click', () => {
              const wsData = [
                ['Equipment', 'Type', 'Properties', 'Alternate From', 'Primary From'],
          ...equipmentList.map(item => [item.Equipment||'', item.Type||'', item.Properties||'', item['Alternate From']||'', item['Primary From']||''])
              ];
              const ws = XLSX.utils.aoa_to_sheet(wsData);
              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, 'Equipment Data');
              XLSX.writeFile(wb, 'updated_equipment_data.xlsx');
            });
            pagination.appendChild(prevBtn);
            pagination.appendChild(pageInfo);
            pagination.appendChild(nextBtn);
            pagination.appendChild(downloadBtn);
      resultArea.appendChild(table);
      resultArea.appendChild(pagination);
    }
  </script>
</body>
</html>
